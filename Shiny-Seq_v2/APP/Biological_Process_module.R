source("functions.R")
Biological_process_module_UI<-function(id)
{
  ns<-NS(id)
  tagList(
    fluidRow(column(10,bsAlert("Others"))),
    bscols(widths = 10,div(style="height: 15px;",width = '200px')),
    a("Click to be directed to Gene Ontology Consortium ", href="http://www.geneontology.org/", target="_blank"),
    bscols(widths = 10,div(style="height: 15px;",width = '200px')),
    fluidRow(column(10,DT::dataTableOutput(ns("Enriched_bp")))),
    br(),
    hr(),
    br(),
    fluidRow(
      column(1,
             selectInput(ns("datachoice10")  ,label = h5("Select Data Type"), 
                         choices = list("Excel" = 1, "CSV" = 2),
                         selected = 1)),
      column(1, 
             br(),
             br(),
             downloadButton(ns('download_Enriched_BP_Table'), 'Download Enriched BP Table'))),
    DT::dataTableOutput(ns("filtered_BP")),
    br(),
    br(),
    hr(),
    br(),
    uiOutput(ns("plot_option_bp")),
    uiOutput(ns("plot_category_bp")),
    uiOutput(ns("plot_category_go")),
    downloadButton(ns('download_bp_plot'), 'Download Plot'),
    plotOutput(ns("bp"))
  )
}

Biological_process_module<-function(input,output,session,DE_genes,
                                    organism,dds.fc,combination,CoCena,orgDB)
{
  #Compute the GO terms based on a list for a list of DE genes(uses function enrichGO from clusterprofiler)
  #Construct  a matrix where row->comparison A vs B, C vs D .etc
  # columns (up regulated GO terms, down regulated GO terms)
  #Loop through a similar matrix generated by reactive DE_genes)
  #Filter GO terms for each element in the matrix generated by reactive DE_genes
  #enrichment analysis
  
  combo<-combination()
  num<-length(combo())
  
  
Enriched_BP<-reactive({
  if (organism() != "Others")
  {
    closeAlert(session, "NotOthers")
    print("inside biological process line 39")
    result<-DE_genes()
   
      if(!is.null(CoCena()))
      {
        cluster_info<-as.data.frame(CoCena()$cluster_calc()[CoCena()$cluster_calc()$cluster_included=="yes",])
          enrichment_main("biological process",result(),organism(),dds.fc(),
                          length(combo()),cluster_info,NULL,orgDB())
        
      }
      else
      {
        combo<-combination()
        num<-length(combo())
        enrichment_main("biological process",result(),organism(),dds.fc(),
                        num,NULL,NULL,orgDB())
      }
  } else {
      createAlert(session, "Others", "NotOthers", title = "Error",
                  content = "This module is not available for organism 'Others'")
    }
  })
  
  #Display summary of biological process
output$Enriched_bp <- DT::renderDataTable({
    
      result<-Enriched_BP()[[1]]
      rows<-num
      modules<-NULL
      WGCNA_matrix<-NULL
      res<-NULL
      
      if(!is.null(CoCena()))
      {
          cluster_info<-as.data.frame(CoCena()$cluster_calc()[CoCena()$cluster_calc()$cluster_included=="yes",])
          entry<-c(as.vector(combo()), as.vector(cluster_info$color))
          rows<-length(entry)
          
          res<-data.frame(matrix(NA, nrow = rows, ncol = 3))
          colnames(res)<-c('Enriched BP for Up-reg genes','Enriched BP for Down-reg genes', 'Enriched BP for included genes')
          rownames(res)<-lapply(1:rows, function(i) {
            unlist(entry[i])
            
          })
          
          for(i in 1:length(combo()))
          {
            res[i,1]<-nrow(as.data.frame(result[[i]][[1]]))
            res[i,2]<-nrow(as.data.frame(result[[i]][[2]]))
            res[i,3]<-0
          }
          
          for(i in (1+length(combo())):(nrow(cluster_info)+length(combo())))
          {
            res[i,1:2]<-0
            res[i,3]<length(result[[i]][[3]])
            
          }
      }
      else
      {
        res<-data.frame(matrix(NA, nrow = length(combo()), ncol = 2))
        rownames(res)<-lapply(1:length(combo()), function(i) {
          combo()[[i]]
          
        })
        colnames(res)<-c('Enriched BP for Up-reg genes','Enriched BP for Down-reg genes')

        for(i in 1:length(combo()))
        {
          res[i,1]<-nrow(as.data.frame(result[[i]][[1]]))
          res[i,2]<-nrow(as.data.frame(result[[i]][[2]]))
        }
        
      }

      DT::datatable(res,class = 'cell-border stripe',
                    selection = list(mode='single',target = 'cell'),
                    extensions = list('Scroller'=NULL,'Buttons'=NULL),
                    options = list(deferRender = TRUE,scrollX = TRUE,scrollY = 150,scroller = TRUE,dom = 'Bfrtip',
                                   buttons = list(list(extend = 'collection',buttons = c('csv', 'excel', 'pdf'),
                                                               text = 'Download table'))),
                    
                    escape = FALSE
      )
    
  })
  
  #Display GO terms for the selected comparison
  observeEvent(input$Enriched_bp_cell_clicked,{
    selected <- input$Enriched_bp_cells_selected
    row<-selected[1]
    col<-selected[2]

    if(length(selected)>0){
      
      output$filtered_BP <- DT::renderDataTable({

        result<-Enriched_BP()[[1]]
        df<-as.data.frame(result[[row]][[col]])
        DT::datatable(df,class = 'cell-border stripe',
                      selection = list(target = 'column'),
                      extensions = list('Scroller'=NULL,'Buttons'=NULL),
                      options = list(deferRender = TRUE,scrollX = TRUE,scrollY = 150,scroller = TRUE,dom = 'Bfrtip',
                                     buttons = list()))
        
      })
      
      #download button
      output$download_Enriched_BP_Table <- downloadHandler(
        
        filename = function() 
        {
          if(as.numeric(input$datachoice10==1)){
          condition <-combo()[[row]]
          if(col==1) paste('Up regulated BP for ',condition,'.xlsx')
          else if(col==2) paste('Down regulated BP for ',condition,'.xlsx') 
          }
          else {
            condition <-combo()[[row]]
            if(col==1) paste('Up regulated BP for ',condition,'.csv')
            else if(col==2) paste('Down regulated BP for ',condition,'.csv') 
          }
          
        },
        content = function(file) {
          #sort by adjusted p value.
          result<-Enriched_BP()[[1]]
          
          df<-as.data.frame(result[[row]][[col]])
          nam<-'Sheet1'
          condition <-combo()[[row]]
          condition<-str_replace_all(condition,"[^[:alnum:]]",".")
          if(col==1) nam<-paste('Up regulated BP for ',condition)
          else if(col==2) nam<-paste('Down regulated BP for ',condition)
          if(as.numeric(input$datachoice10==1)){
            M <- as.matrix(df)
            wb <- createWorkbook()
            addWorksheet(wb, sheetName = "Biological Processes")
            writeData(wb = wb, sheet = 1, x = M, colNames = T, rowNames = T)
            saveWorkbook(wb, file)
          }
          else{
            write.csv(df, file)
          }
          
        }
        
      )
      
      output$plot_category_bp<-renderUI({
        textInput(session$ns("category_bp"),label = h6("Enter number of categories to display"), 
                  value = "10") 
      })
      output$plot_category_go<-renderUI({
        textInput(session$ns("category_go"),label = h6("Enter number of GO levels to display"), 
                  value = "") 
      })
      print(as.numeric(input$category_bp))
      
      #Display boxplot of to 10 GO term of selected comparison
      bpplot<-reactive(
      {
        result<-Enriched_BP()[[2]] #obj
        res<-Enriched_BP()[[1]]
        req(input$category_bp)
        
        if(nrow(res[[row]][[col]]) == 0){
          warning("No Data available for plotting")
        }
        else if(nrow(res[[row]][[1]]) == 0 && nrow(res[[row]][[2]] != 0)){
          enrichment_plot("biological process",result,res,row,1,input$category_bp,input$category_go)
        }
        else{
          enrichment_plot("biological process",result,res,row,col,input$category_bp,input$category_go)
        }
      })
        
      output$bp<- renderPlot({
        bpplot()
      })
      output$download_bp_plot <- downloadHandler(
        
        filename =function()
        {
          condition <-combo()[[row]]
          if(col==1) paste('Barplot of Up regulated BP for ',condition,'.pdf')
          else if(col==2) paste(' Barplot of Down regulated BP for ',condition,'.pdf')
        },
        content = function(file) {
          req(input$category_bp)

            ggsave(file,bpplot())#,width=800, height=500
          
        })
    }
  })
  return(list(
    Enriched_BP_table=reactive({Enriched_BP()[[1]]}),
    Enriched_BP_obj=reactive({Enriched_BP()[[2]]})
  )
    
  )
}