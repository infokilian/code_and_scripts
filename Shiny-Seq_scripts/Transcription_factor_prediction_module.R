source("./gene_count_module.r")
#####################################transcription factor prediction(primo)##########################
#Compute the Transcription factor(Uses primo function)
#Construct  a matrix where row->comparison A vs B, C vs D .etc
# columns (up regulated genes, down regulated genes, all DE genes)
#Loop through a similar matrix generated by reactive DE_genes)
#Filter TF for each element in the matrix generated by reactive DE_genes

predicted_TF_module_UI<-function(id)
{
  ns<-NS(id)
  tagList(
    fluidRow(column(10,DT::dataTableOutput(ns("predicted_TF")))),
    textOutput(ns("text_pred")),
    fluidRow(column(10,DT::dataTableOutput(ns("All_predicted_TF")))),
    radioButtons(ns("lfc_pred_TF"), "Show log2 foldchange?:", choices = c("Yes", "No"),selected = "No"),
    downloadButton(ns('download_DE_pred_TF_Table'), 'Download full Data'),
    DT::dataTableOutput(ns("filtered_predicted_TF")),
    gene_count_module_UI(ns("module4"))
    # uiOutput("plot_option_gene_predicted_TF"),
    # downloadButton('download_gene_predicted_tf', 'Download plot'),
    # plotOutput("gene_plot_predicted_TF")
    # 
  )
}
predicted_TF_module<-function(input,output,session,
                              DE_genes,dds.fc,anova_table,
                              combination,conchoice,wgcna_output,
                              organism,normal,batch_choice,batch_corrected)
{
predicted_TF<-reactive({
  # Create a Progress object
  progress <- shiny::Progress$new()
  # Make sure it closes when we exit this reactive, even if there's an error
  on.exit(progress$close())
  
  #get all de genes
  result<-DE_genes()
  combo<-combination()
  print(combo)
  num <- length(combo())
  k<-0
  progress$set(message = "Processing Data", value = 0)
  
  Enriched_dt<-list()
  All_pred_tf<-list()
  All_idx<-list()
  
  #########preparing the anova table in the order as output#########
  a_tab<-anova_table()[,-c(2,3)]
  cond<-unique(colData(dds.fc()[[1]])[,as.numeric(conchoice())])
  print(cond)
  c<-colnames(a_tab)
  print(length(c))
  temp<-as.vector(c[4:(3+length(cond))])
  temp2<-as.vector(c[(length(cond)+4):length(c)])
  print(temp2)
  # #temp<-as.vector(c[7:length(c)])
  print(c(temp,c[2],c[3],temp2,c[1]))
  print('howdy')
  # print(c)
  # anova <- 
  print(head(a_tab[,c(temp,c[2],c[3],temp2,c[1])]))
  all_genes=a_tab[,c(temp,c[2],c[3],temp2,c[1])]
  ##################################################################
  for(i in 1:num)
  {
    dt<-list()
    All_pred<-list()
    idx_pred<-list()
    for(j in 1:3)
    {
      k<-k+1
      
      print("k")
      res<-as.data.frame(result()[[i]][[j]])
      print(head(res))
      TFs<-NULL
      TF_table<-NULL
      if(nrow(res)!=0)
      {
        genes<-res[,1]
        df<-res[,-1]
        rownames(df)<-genes  
        print(length(genes))
        if(as.numeric(organism())==2){#mouse
          reg=AnnotationDbi::select(org.Mm.eg.db,rownames(df),"ENTREZID","SYMBOL",multiVals="first")
          idx <- match(rownames(df), reg$SYMBOL)
          #print(idx)
          print(length(idx))
          print(length(rownames(df)))
          df$entrez<-reg[idx,]$ENTREZID
          
          #e = bitr(genes, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Mm.eg.db")
          #cluster_entrez <- unlist(e[2],use.names = FALSE)
          cluster_entrez <- unlist(df$entrez,use.names = FALSE)
          print(head(cluster_entrez))
          print(is.na(cluster_entrez))
          
          TFtable <- primo(na.omit(cluster_entrez), inputType = "entrezID", org = "Mm")
          print('tftable')
          print(head(TFtable))
          TFs <- str_split(TFtable$overRepresented[,4], "_") #5th col is p val
          TFs <- do.call(rbind, TFs)[,1]
          TFs <- str_split(TFs, "::")
          TFs <- do.call(rbind, TFs)
          if(grepl(":", TFs)&&!is.null(TFs)){
            TFs <- c(TFs[,1],TFs[,2])
          }
          TFs <-unique(TFs)
          TFs <- str_to_title(TFs, locale = "")
          TF_table<-TFtable$overRepresented
          
        }else if(as.numeric(organism())==1){ #human
          reg=AnnotationDbi::select(org.Hs.eg.db,rownames(df),"ENTREZID","SYMBOL",multiVals="first")
          idx <- match(rownames(df), reg$SYMBOL)
          #print(idx)
          print(length(idx))
          print(length(rownames(df)))
          df$entrez<-reg[idx,]$ENTREZID
          
          #e = bitr(genes, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Mm.eg.db")
          #cluster_entrez <- unlist(e[2],use.names = FALSE)
          cluster_entrez <- unlist(df$entrez,use.names = FALSE)
          print(head(cluster_entrez))
          print(is.na(cluster_entrez))
          
          TFtable <- primo(na.omit(cluster_entrez), inputType = "entrezID", org = "Hs")
          print('tftable')
          #print(head(TFtable))
          TFs <- str_split(TFtable$overRepresented[,4], "_")
          TFs <- do.call(rbind, TFs)[,1]
          TFs <- str_split(TFs, "::")
          TFs <- do.call(rbind, TFs)
          if(grepl(":", TFs)&&!is.null(TFs)){
            TFs <- c(TFs[,1],TFs[,2])
          }
          TFs <-unique(TFs)
          TFs <- str_to_upper(TFs, locale = "")
          TF_table<-TFtable$overRepresented
        }  
        print(head(TFs))
        if(!is.null(TFs))
        {
          print("predicted tfs")
          print(head(TFs))
          print(head(all_genes))
          anova_genes<-rownames(all_genes)
          #anova_genes<-rownames(all_genes[which(rownames(all_genes) %in% TFs),])
          print(head(which(anova_genes %in% TFs)))
          print(head(all_genes[which(anova_genes %in% TFs),]))
          dt[[length(dt)+1]]<-all_genes[which(anova_genes %in% TFs),]
          All_pred[[length(All_pred)+1]]<-TF_table#TFs
          
          de_genes_pred_idx<-which(anova_genes %in% rownames(res))
          print(de_genes_pred_idx)
          idx_pred[[length(idx_pred)+1]]<-de_genes_pred_idx
          
        }
        else
        {
          dt[[length(dt)+1]]<-NULL
          All_pred[[length(All_pred)+1]]<-NULL
          idx_pred[[length(idx_pred)+1]]<-NULL
        }
      }
      else
      {
        dt[[length(dt)+1]]<-NULL 
        All_pred[[length(All_pred)+1]]<-NULL
        idx_pred[[length(idx_pred)+1]]<-NULL
      }
    }
    
    Enriched_dt[[i]]<-dt
    All_pred_tf[[i]]<-All_pred
    All_idx[[i]]<-idx_pred
  }
  if(!is.null(wgcna_output()))
  {
    if((length(wgcna_output()$modules())>0))
    {
      mod<- wgcna_output()$modules()
      modules<-as.data.frame(table(mod))
      colnames(modules)<-c("Var1","number")
      WGCNA_matrix<-wgcna_output()$WGCNA_matrix()
      for(i in 1:nrow(modules))
      {
        
        print('freq')
        print(modules$Freq[i])
        
        idx_w<-which(mod==modules$Var1[i])
        #print(head(idx_w))
        DEG<-colnames(WGCNA_matrix)[idx_w]
        print(head(as.data.frame(DEG)))
        if(!identical(character(0),DEG))
        {
          if(as.numeric(organism())==1)
          {
            reg=AnnotationDbi::select(org.Hs.eg.db,DEG,"ENTREZID","SYMBOL",multiVals="first")
            idx <- match(DEG, reg$SYMBOL)
            #print(idx)
            #print(length(idx))
            #print(length(DEG))
            entrez<-reg[idx,]$ENTREZID
            
            #e = bitr(genes, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Mm.eg.db")
            #cluster_entrez <- unlist(e[2],use.names = FALSE)
            cluster_entrez <- unlist(entrez,use.names = FALSE)
            #print(head(cluster_entrez))
            #print(is.na(cluster_entrez))
            
            TFtable <- primo(na.omit(cluster_entrez), inputType = "entrezID", org = "Hs")
            print('tftable')
            #print(head(TFtable))
            TFs <- str_split(TFtable$overRepresented[,4], "_")
            TFs <- do.call(rbind, TFs)[,1]
            TFs <- str_split(TFs, "::")
            TFs <- do.call(rbind, TFs)
            if(grepl(":", TFs)&&!is.null(TFs)){
              TFs <- c(TFs[,1],TFs[,2])
            }
            TFs <-unique(TFs)
            TFs <- str_to_upper(TFs, locale = "")
            TF_table<-TFtable$overRepresented
          }
          else if (as.numeric(organism())==2)
          {
            reg=AnnotationDbi::select(org.Mm.eg.db,DEG,"ENTREZID","SYMBOL",multiVals="first")
            idx <- match(DEG, reg$SYMBOL)
            #print(idx)
            #print(length(idx))
            #print(length(DEG))
            entrez<-reg[idx,]$ENTREZID
            
            #e = bitr(genes, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Mm.eg.db")
            #cluster_entrez <- unlist(e[2],use.names = FALSE)
            cluster_entrez <- unlist(entrez,use.names = FALSE)
            #print(head(cluster_entrez))
            #print(is.na(cluster_entrez))
            
            TFtable <- primo(na.omit(cluster_entrez), inputType = "entrezID", org = "Mm")
            print('tftable')
            #print(head(TFtable))
            TFs <- str_split(TFtable$overRepresented[,4], "_") #5th col is p val
            TFs <- do.call(rbind, TFs)[,1]
            TFs <- str_split(TFs, "::")
            TFs <- do.call(rbind, TFs)
            if(grepl(":", TFs)&&!is.null(TFs)){
              TFs <- c(TFs[,1],TFs[,2])
            }
            TFs <-unique(TFs)
            TFs <- str_to_title(TFs, locale = "")
            TF_table<-TFtable$overRepresented
          }
          if(!is.null(TFs))
          {
            print("predicted tfs")
            #print(TFs)
            d<-data.frame(matrix(NA, nrow = 0, ncol = 1))
            Enriched_dt[[length(Enriched_dt)+1]]<-list(NULL,NULL,all_genes[which(rownames(all_genes) %in% TFs),])
            All_pred_tf[[length(All_pred_tf)+1]]<-list(d,d,TF_table)#TFs
            anova_genes<-rownames(all_genes[which(rownames(all_genes) %in% TFs),])
            de_genes_pred_idx<-which(anova_genes %in% DEG)
            All_idx[[length(All_idx)+1]]<-list(NULL,NULL,NULL)#de_genes_pred_idx)
            
          }
          else
          {
            d<-data.frame(matrix(NA, nrow = 0, ncol = 1))
            Enriched_dt[[length(Enriched_dt)+1]]<-list(NULL,NULL,NULL)
            All_pred_tf[[length(All_pred_tf)+1]]<-list(d,d,d)
            All_idx[[length(All_idx)+1]]<-list(NULL,NULL,NULL)
          }
          
          
        }
        else
        {
          d<-data.frame(matrix(NA, nrow = 0, ncol = 1))
          Enriched_dt[[length(Enriched_dt)+1]]<-list(NULL,NULL,NULL)
          All_pred_tf[[length(All_pred_tf)+1]]<-list(d,d,d)
          All_idx[[length(All_idx)+1]]<-list(NULL,NULL,NULL)
        }
      }
      
    }
  }
  print('all')
  print(head(All_idx))
  list(Enriched_dt,All_pred_tf,All_idx)
})
output$predicted_TF <- DT::renderDataTable({
  if(!is.null(DE_genes())){
    
    result<-predicted_TF()[[2]]
    #print(head(result))
    
    #num <- length(combination())
    combo<-combination()
    num<-length(combo())
    rows<-num
    modules<-NULL
    WGCNA_matrix<-NULL
    res<-data.frame(matrix(NA, nrow = num, ncol = 3))
    if(!is.null(wgcna_output()))
    {
      if((length(wgcna_output()$modules())>0))
      {
        combo<-combination()
        num<-length(combo())
        modules<-as.data.frame(table(wgcna_output()$modules()))
        entry<-c(as.vector(combo()), as.vector(modules$Var1))
        # print(modules$Var1)
        #print(entry)
        rows<-length(entry)
        
        res<-data.frame(matrix(NA, nrow = rows, ncol = 3))
        colnames(res)<-c('Up regulated','Down regulated','Regulated')
        
        
        #print(modules$Var1)
        #print(entry)
        rownames(res)<-lapply(1:rows, function(i) {
          unlist(entry[i])
          
        })
        for(i in 1:num)
        {
          #print(nrow(as.data.frame(result[[i]][1])))
          res[i,1]<-nrow(as.data.frame(result[[i]][[1]]))
          res[i,2]<-nrow(as.data.frame(result[[i]][[2]]))
          res[i,3]<-nrow(as.data.frame(result[[i]][[3]]))
        }
        
        for(i in 1:nrow(modules))
        {
          #print(nrow(as.data.frame(result[[i]][1])))
          print('res')
          #print(result[[num+i]][[3]])
          res[num+i,1:2]<-0
          res[num+i,3]<-nrow(as.data.frame(result[[num+i]][3]))
          
        }
      }
    }
    else{
      combo<-combination()
      num<-length(combo())
      rownames(res)<-lapply(1:num, function(i) {
        #paste(combination()[[i]][1],' vs ',combination()[[i]][2])
        combo()[[i]]
        
      })
      colnames(res)<-c('Predicted TF for Up-reg genes','Predicted TF for Down-reg genes','Predicted TF for All genes')
      print(res)
      print(res[1,1])
      print("pred")
      print(head(result))
      for(i in 1:num)
      {
        print(nrow(as.data.frame(result[[i]][[1]])))
        res[i,1]<-nrow(as.data.frame(result[[i]][[1]]))
        res[i,2]<-nrow(as.data.frame(result[[i]][[2]]))
        res[i,3]<-nrow(as.data.frame(result[[i]][[3]]))
      }
      print(res)
    }
    
    
    print(res)
    DT::datatable(res,class = 'cell-border stripe',
                  selection = list(mode='single',target = 'cell'),
                  extensions = list('Scroller'=NULL,'Buttons'=NULL),
                  options = list(deferRender = TRUE,scrollX = TRUE,scrollY = 150,scroller = TRUE,dom = 'Bfrtip',
                                 buttons = list('copy', list(extend = 'collection',buttons = c('csv', 'excel', 'pdf'),
                                                             text = 'Download table'))),#I('colvis')
                  
                  escape = FALSE
    )
  }
})

observeEvent(input$predicted_TF_cell_clicked,{
  print('hey')
  print(input$predicted_TF_cells_selected)
  print(input$predicted_TF_cell_clicked)
  selected <- input$predicted_TF_cells_selected
  row<-selected[1]
  print('row')
  print(row)
  col<-selected[2]
  print('col')
  print(col)
  if(length(selected)>0){
    output$All_predicted_TF<- DT::renderDataTable({
      print('hey')
      result<-predicted_TF()[[2]]
      df<-as.data.frame(result[[row]][[col]])
      #print(df)
      colnames(df)<-c("Id","BaseId","pwmLength","Predicted Transcription factors","pValue")
      DT::datatable(df,class = 'cell-border stripe',
                    selection = list(mode='single',target = 'row'),
                    extensions = list('Scroller'=NULL,'Buttons'=NULL),
                    options = list(deferRender = TRUE,scrollX = TRUE,scrollY = 150,scroller = TRUE,dom = 'Bfrtip',
                                   buttons = list('copy', list(extend = 'collection',buttons = c('csv', 'excel', 'pdf'),
                                                               text = 'Download only genes on clipboard'))))
      
    })
    output$text_pred<-renderText({
      result<-predicted_TF()[[1]]
      df<-as.data.frame(result[[row]][[col]])
      all_pred_tf<-predicted_TF()[[2]]
      if(col==1)  paste(nrow(df),"out  of ",length(all_pred_tf)," predicted and up regulated transcription factors are present in the dataset")
      else if(col==2) paste(nrow(df),"out  of ",length(all_pred_tf)," predicted and down regulated transcription factors are present in the dataset")
      else paste(nrow(df),"out  of ",length(all_pred_tf)," predicted transcription factors are present in the dataset")
      
    })
    
    output$filtered_predicted_TF <- DT::renderDataTable({
      print('hey')
      result<-predicted_TF()[[1]]
      df<-as.data.frame(result[[row]][[col]])
      #print(head(df))
      idx_all<-predicted_TF()[[3]]
      print(idx_all)
      idx<-idx_all[[row]][[col]]
      print(idx)
      print(rownames(df)[idx])
      print(colnames(df)[1])
      # genes<-df[,1]
      # df<-df[-1]
      # rownames(df)<-genes
      if(input$lfc_pred_TF =="No")
      {
        names<-colnames(df)
        id<-grep("log2FoldChange",names)
        df=df[,-id]
      }
      #else anova=a_tab
      gene_names<-rownames(df)
      df_final<-cbind(gene_names,df)
      colnames(df_final)[1]<-'Gene names'
      print(head(df_final))
      print('idx')
      print(idx)
      de_genes<-gene_names[idx]#c('E2f1','Nfkb1')
      print(de_genes)
      #dat<-
      dat<-DT::datatable(df_final,class = 'cell-border stripe',
                         selection = list(mode='single',target = 'row'),
                         extensions = list('Scroller'=NULL,'Buttons'=NULL),
                         options = list(deferRender = TRUE,scrollX = TRUE,scrollY = 150,scroller = TRUE,dom = 'Bfrtip',
                                        buttons = list('copy', list(extend = 'collection',buttons = c('csv', 'excel', 'pdf'),
                                                                    text = 'Download only genes on clipboard'))))
      if(!is.null(de_genes) || !identical(character(0),de_genes))
        dat%>% formatStyle('Gene names',target = 'row',backgroundColor =styleEqual(de_genes,rep('yellow',length(de_genes))))
      #return(dat)
      dat
    })
    ###plotcounts of gene
    #display filtered ANOVA table for the selcted comparisons
    #display boxplot of gene selcted in the fitered ANOVA table
    observeEvent(input$filtered_predicted_TF_rows_selected,{
      #get which gene was clicked
      #get the row  number of the gene clicked
      print('hey')
      print(input$filtered_predicted_TF_rows_selected)
      #print(input$ANOVA_rows_clicked)
      selected_row <- input$filtered_predicted_TF_rows_selected
      print(selected_row)
      #get the normalized data
      full_data<-normal()
      print(head(full_data))
      print('hey')
      #get the DE table where we clicked the gene
      print(input$predicted_TF_cells_selected)
      print(input$predicted_TF_cell_clicked)
      selected <- input$predicted_TF_cells_selected
      row<-selected[1]
      print('row')
      print(row)
      col<-selected[2]
      print('col')
      print(col)
      if(length(selected)>0)
      {
        print('hey')
        #get the table where we clicked the TF
        result<-predicted_TF()[[1]]
        #df<-as.data.frame(result[[row]][[col]])
        df_final<-as.data.frame(result[[row]][[col]])
        # df_final<- df[order(df$padj),]
        print(head(df_final))
        print("gene")
        # genes<-df[,1]
        # df<-df[-1]
        # rownames(df)<-genes
        #get the gene
        an_gene<-rownames(df_final)[selected_row]
        #an_gene<-df_final[selected_row,1]
        print(an_gene)
        counts<-as.vector(full_data[which(an_gene %in% rownames(full_data)),])
        #print(counts)
        #print(as.factor(colData(dds.fc()[[1]])[,as.numeric(input$conchoice)]))
        cond<-as.vector(colData(dds.fc()[[1]])[,as.numeric(conchoice())])
        #rownames(cond)<-colData(dds.fc()[[1]])[,1]
        library('data.table')
        print(length(counts))
        print(length(cond))
        df<-data.frame(counts,cond)
        colnames(df)<-c('count','condition')
        print(head(df))
        print(batch_choice())
        print(as.numeric(batch_choice()))
        batch<-batch_choice()
        if(as.numeric(batch)==1) callModule(gene_count_module,"module4",NULL,reactive({dds.fc()[[1]]}),reactive({an_gene}))
        else
          {
            idx<-which(rownames(batch_corrected()) %in% an_gene)
            print(idx)
            callModule(gene_count_module,"module4",batch_corrected()[idx,],reactive({dds.fc()[[1]]}),reactive({an_gene}))
          }
      }
      })
    #download button
    output$download_DE_pred_TF_Table <- downloadHandler(
      
      filename = function() 
      {
        #condition<-paste(combination()[[row]][1],' vs ',combination()[[row]][2])
        combo<-combination()
        condition<-combo()[[row]]
        if(col==1) paste('Up regulated predicted TF for ',condition,'.xlsx')
        else if(col==2) paste('Down regulated predicted TF for ',condition,'.xlsx')
        else paste('All DE predicted TF for ',condition,'.xlsx')
        #paste("DE genes for condition ",input$condition1," vs ",input$condition2,'.csv')
      },
      content = function(file) {
        #sort by adjusted p value.
        print('heyho')
        result<-predicted_TF()[[1]]
        df<-as.data.frame(result[[row]][[col]])
        # genes<-df[,1]
        # df<-df[-1]
        # rownames(df)<-genes
        df_final<- df[order(df$padj),]
        colnames(df_final)[1]<-"Overall mean"
        for (i in 8:length(colnames(df_final)))
        {
          colnames(df_final)[i]<-paste(colnames(df_final)[i],"mean")
        }
        #write.csv(df_final, file)
        nam<-"Sheet 1"
        combo<-combination()
        condition<-combo()[[row]]
        condition<-str_replace_all(condition,"[^[:alnum:]]",".")
        if(col==1) nam<-paste('Up regulated Kegg for ',condition)
        else if(col==2) nam<-paste('Down regulated Kegg for ',condition)
        else if(col==3) nam<-paste('regulated Kegg for ',condition)
        write.xlsx2(df_final, file, sheetName = nam,
                    col.names = TRUE, row.names = TRUE, append = FALSE)
      }
      
    )
  }
})
}
# ###plotcounts of gene
# #display filtered ANOVA table for the selcted comparisons
# #display boxplot of gene selcted in the fitered ANOVA table
# observeEvent(input$filtered_predicted_TF_rows_selected,{
#   #get which gene was clicked
#   #get the row  number of the gene clicked
#   print('hey')
#   print(input$filtered_predicted_TF_rows_selected)
#   #print(input$ANOVA_rows_clicked)
#   selected_row <- input$filtered_predicted_TF_rows_selected
#   print(selected_row)
#   #get the normalized data
#   full_data<-normal()
#   print(head(full_data))
#   print('hey')
#   #get the DE table where we clicked the gene
#   print(input$predicted_TF_cells_selected)
#   print(input$predicted_TF_cell_clicked)
#   selected <- input$predicted_TF_cells_selected
#   row<-selected[1]
#   print('row')
#   print(row)
#   col<-selected[2]
#   print('col')
#   print(col)
#   if(length(selected)>0)
#   {
#     print('hey')
#     #get the table where we clicked the TF
#     result<-predicted_TF()[[1]]
#     #df<-as.data.frame(result[[row]][[col]])
#     df_final<-as.data.frame(result[[row]][[col]])
#     # df_final<- df[order(df$padj),]
#     print(head(df_final))
#     print("gene")
#     # genes<-df[,1]
#     # df<-df[-1]
#     # rownames(df)<-genes
#     #get the gene
#     an_gene<-rownames(df_final)[selected_row]
#     #an_gene<-df_final[selected_row,1]
#     print(an_gene)
#     counts<-as.vector(full_data[which(an_gene %in% rownames(full_data)),])
#     #print(counts)
#     #print(as.factor(colData(dds.fc()[[1]])[,as.numeric(input$conchoice)]))
#     cond<-as.vector(colData(dds.fc()[[1]])[,as.numeric(input$conchoice)])
#     #rownames(cond)<-colData(dds.fc()[[1]])[,1]
#     library('data.table')
#     print(length(counts))
#     print(length(cond))
#     df<-data.frame(counts,cond)
#     colnames(df)<-c('count','condition')
#     print(head(df))
#     output$plot_option_gene_predicted_TF<-renderUI({
#       if(as.numeric(input$batch_choice)==1)
#       {
#         radioButtons("plotType_gene_predicted_TF", "use log scale?:", choices = c("Yes", "No"),selected = "Yes")
#       }
#     })
#     geneplotpredictedtf<-reactive({
#       if(as.numeric(input$batch_choice)!=1)
#       {
#         geneCounts <- plotCounts(batch_corrected()[[1]][selected_row,],dds.fc()[[1]], gene=an_gene, intgroup="condition", returnData=TRUE)
#         ggplot(geneCounts, aes(x=condition, y=count,fill=condition)) +
#           geom_boxplot()+
#           geom_point(position=position_jitter(width=.1,height=0), size=3)+
#           ggtitle(paste0("Gene name: ",an_gene)) +
#           labs(x="Condition",y="Batch corrected counts") +
#           theme(plot.title = element_text(family = "Trebuchet MS", color="#666666", face="bold", size=30, hjust=0.5)) +
#           theme(axis.title = element_text(family = "Trebuchet MS", color="#666666", face="bold", size=22))+
#           theme_bw()#for no grey background
#       }
#       else if(as.numeric(input$batch_choice)==1)
#       {
#         if(!is.null(input$plotType_gene_predicted_TF))
#         {
#           if(input$plotType_gene_predicted_TF=="Yes")
#           {
#             geneCounts <- plotCounts(NULL,dds.fc()[[1]], gene=an_gene, intgroup="condition", returnData=TRUE)
#             ggplot(geneCounts, aes(x=condition, y=count,fill=condition)) +
#               geom_boxplot()+
#               scale_y_continuous(trans='log2') +
#               geom_point(position=position_jitter(width=.1,height=0), size=3)+
#               ggtitle(paste0("Gene name: ",an_gene)) +
#               labs(x="Condition",y="Normalized counts") + 
#               theme(plot.title = element_text(family = "Trebuchet MS", color="#666666", face="bold", size=32, hjust=0.5)) +
#               theme(axis.title = element_text(family = "Trebuchet MS", color="#666666", face="bold", size=22))+
#               theme_bw()#for no grey background
#             
#           }
#           else if(input$plotType_gene_predicted_TF=="No")
#           {
#             geneCounts <- plotCounts(NULL,dds.fc()[[1]], gene=an_gene, intgroup="condition", returnData=TRUE)
#             ggplot(geneCounts, aes(x=condition, y=count,fill=condition)) +
#               geom_boxplot()+
#               geom_point(position=position_jitter(width=.1,height=0), size=3)+
#               ggtitle(paste0("Gene name: ",an_gene)) +
#               labs(x="Condition",y="Normalized counts") + 
#               theme(plot.title = element_text(family = "Trebuchet MS", color="#666666", face="bold", size=30, hjust=0.5)) +
#               theme(axis.title = element_text(family = "Trebuchet MS", color="#666666", face="bold", size=22))+
#               theme_bw()#for no grey background
#             
#           }
#         }
#       }
#       
#     })
#     output$gene_plot_predicted_TF<-renderPlot({
#       
#       geneplotpredictedtf()
#       
#     })
#     output$download_gene_predicted_tf <- downloadHandler(
#       filename = paste(" Gene counts of",an_gene," nomalized counts.svg"),
#       content = function(file) {
#         #png(file)
#         ggsave(file,geneplotpredictedtf())
#         #dev.off()
#       }) 
#   }
# })